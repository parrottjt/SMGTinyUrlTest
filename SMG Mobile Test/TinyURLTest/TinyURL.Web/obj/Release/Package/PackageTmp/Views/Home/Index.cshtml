@using System.Activities.Statements
@model TinyURL.Web.Models.ImageViewModel
@{
    ViewBag.Title = "Upload Image";

    WebImage photo = null;


    bool fileExists = false;

    string pathToImage = "";
    string validationMessage = "";

    //This handles the post from the Upload button
    //if (IsPost)
    //{
    //    photo = WebImage.GetImageFromRequest();
    //    if (photo != null)
    //    {
    //        //This Validates the file to ensure it is of the proper format
    //        Model.ValidateFile(photo, out pathToImage, out fileExists, out validationMessage);
    //    }
    //}

}

@{
    // Gathered from https://docs.microsoft.com/en-us/aspnet/web-pages/overview/ui-layouts-and-themes/9-working-with-images
    // Added the tiny url to this location.
}
<div class="page-header">
    <p>
        @Html.ActionLink("List", "List", "Home")
    </p>
    <form action="" method="post" enctype="multipart/form-data">
        <fieldset>
            <legend> Image Upload </legend>
            <label>Image(s)</label>
            <div id="uploadBox" style="background-color:lightblue; width: 15vw;">
                <p class="text-center" style="padding: 1vh; font-size: medium">Drag and Drop Images</p>
            </div>
            <input type="file" name="Image" />
            <br />
            <p id="filesToUploadCount"></p>
            <br/>
            <input id="uploadButton" type="submit" value="Upload" />
            <br/>
            <p>@ViewBag.ValidationStatus</p>
        </fieldset>
    </form>
    
    <!--Move This section to a modal or another page-->
    <h1>Uploaded Image</h1>
    @if (pathToImage != "" && !fileExists)
    {
        <div class="result">
            <p>Tiny URL: @Model.CreateTinyUrl(pathToImage)</p>
            <img src="@pathToImage" alt="image" />

        </div>
    }
</div>

@section scripts
{
    <script>
        var selectedFiles;

        $(document).ready(AddEventListeners);

        function AddEventListeners() {
            var box = document.getElementById("uploadBox");
            box.addEventListener("dragenter", OnDragEnter, false);
            box.addEventListener("dragover", OnDragOver, false);
            box.addEventListener("drop", OnDrop, false);

            $("#uploadButton").click(OnClick);
        }

        function OnDragEnter(e) {
            e.stopPropagation();
            e.preventDefault();
        }

        function OnDragOver(e) {
            e.stopPropagation();
            e.preventDefault();
        }

        function OnDrop(e) {
            e.stopPropagation();
            e.preventDefault();

            selectedFiles = e.dataTransfer.files;
            $("#filesToUploadCount").text(selectedFiles.length + "file(s) selected for uploading!");
        }

        function OnClick(e) {
            var data = new FormData();
            for (var i = 0; i < selectedFiles.length; i++) {
                data.append(selectedFiles[i].name, selectedFiles[i]);
            }
            $.ajax({
                type: "POST",
                url: "FileUpload.ashx",
                contentType: false,
                processData: false,
                data: data,
                success: function(result) {
                    alert(result);
                },
                error: function () {
                    alert("There was an error uploading files");
                }
            });
        }
    </script>
}